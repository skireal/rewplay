name: eBay Tracker

on:
  # Запуск по расписанию
  # Формат: минута час день месяц день_недели
  # Примеры:
  # - cron: '*/30 * * * *'    # Каждые 30 минут
  # - cron: '*/15 * * * *'    # Каждые 15 минут
  # - cron: '0 * * * *'       # Каждый час (в начале часа)
  # - cron: '0 */2 * * *'     # Каждые 2 часа
  # - cron: '0 */6 * * *'     # Каждые 6 часов
  # - cron: '0 9,21 * * *'    # Два раза в день (9:00 и 21:00 UTC)
  # - cron: '0 9-21/2 * * *'  # Каждые 2 часа с 9:00 до 21:00 UTC
  schedule:
    - cron: '*/30 * * * *'    # Текущее: каждые 30 минут

  # Ручной запуск через GitHub UI
  workflow_dispatch:

  # Запуск при push (для тестирования)
  push:
    branches:
      - main
    paths:
      - 'ebay-tracker/**'
      - '.github/workflows/ebay-tracker.yml'

jobs:
  track-ebay:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'ebay-tracker/requirements.txt'

      - name: Install dependencies
        run: |
          cd ebay-tracker
          pip install -r requirements.txt

      - name: Restore database from artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: tracker-database
          path: ebay-tracker/db/

      - name: Run eBay Tracker
        env:
          EBAY_APP_ID: ${{ secrets.EBAY_APP_ID }}
          EBAY_CERT_ID: ${{ secrets.EBAY_CERT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          SEARCH_KEYWORDS: ${{ secrets.SEARCH_KEYWORDS }}
          EBAY_SITE_ID: ${{ secrets.EBAY_SITE_ID }}
          MAX_RESULTS: ${{ secrets.MAX_RESULTS }}
          MIN_PRICE: ${{ secrets.MIN_PRICE }}
          MAX_PRICE: ${{ secrets.MAX_PRICE }}
          CONDITION_FILTER: ${{ secrets.CONDITION_FILTER }}
        run: |
          cd ebay-tracker
          python tracker.py

      - name: Save database to artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tracker-database
          path: ebay-tracker/db/tracker.db
          retention-days: 90

      - name: Commit database changes (alternative persistence)
        if: success()
        run: |
          cd ebay-tracker

          # Проверяем есть ли изменения в базе
          if [ -f "db/tracker.db" ]; then
            # Настраиваем git
            git config user.name "GitHub Actions Bot"
            git config user.email "actions@github.com"

            # Добавляем базу в git (если еще не добавлена)
            git add db/tracker.db

            # Коммитим если есть изменения
            if ! git diff --cached --quiet; then
              git commit -m "Update tracker database - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
              git pull --rebase origin ${{ github.ref_name }}
              git push origin ${{ github.ref_name }}
            else
              echo "No database changes to commit"
            fi
          fi
